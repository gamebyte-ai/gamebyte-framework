<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GameByte - Space Shooter Demo</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            overflow: hidden;
            background: #0a0a20;
            touch-action: none;
        }
        canvas { display: block; }
    </style>
</head>
<body>
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@8/dist/pixi.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script src="/gamebyte.umd.js"></script>

    <script>
        // =====================================================
        // Space Shooter Demo - GameByte Framework Components
        // =====================================================
        // Showcases:
        // - SplashScreen for game intro
        // - Simple Main Menu with GameStyleButton
        // - GameTopBar for score/lives/wave display
        // - GameStyleButton for mobile fire button
        // - VirtualJoystick for mobile movement
        // - ResultScreen for game over state
        // - CelebrationManager for confetti effects
        // - game.on('update') for game loop
        // Game states: 'splash' -> 'menu' -> 'playing' -> 'gameover'
        // =====================================================

        const {
            createGame,
            graphics,
            loadFrameworkFont,
            SplashScreen,
            GameStyleButton,
            GameStyleColors,
            GameTopBar,
            ResultScreen,
            VirtualJoystick,
            CelebrationManager
        } = GameByteFramework;

        const CONFIG = {
            width: 500,
            height: 650,
            playerSpeed: 6,
            bulletSpeed: 10,
            enemyBulletSpeed: 5
        };

        let game, stage, gfx;
        let mainContainer, worldContainer, uiContainer;
        let player, playerEngine;
        let bullets = [], enemyBullets = [], enemies = [], stars = [], explosions = [];
        let score = 0, lives = 3, wave = 1;
        let gameState = 'splash'; // States: 'splash' -> 'menu' -> 'playing' -> 'gameover'
        let lastShot = 0, playerInvincible = 0;
        let keys = { left: false, right: false, up: false, down: false, fire: false };

        // Framework UI Components
        let splashScreen, mainMenu, topBar, joystick, fireButton, resultScreen, celebrationManager;

        const canvas = document.createElement('canvas');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        document.body.appendChild(canvas);

        async function init() {
            await loadFrameworkFont();

            game = createGame();
            await game.initialize(canvas, '2d');

            const renderer = game.make('renderer');
            stage = renderer.getStage();
            gfx = graphics();

            // Responsive scaling
            const scaleX = window.innerWidth / CONFIG.width;
            const scaleY = window.innerHeight / CONFIG.height;
            const scale = Math.min(scaleX, scaleY);

            mainContainer = gfx.createContainer();
            mainContainer.scale.set(scale);
            mainContainer.x = (window.innerWidth - CONFIG.width * scale) / 2;
            mainContainer.y = (window.innerHeight - CONFIG.height * scale) / 2;
            stage.addChild(mainContainer);

            // World container
            worldContainer = gfx.createContainer();
            mainContainer.addChild(worldContainer);

            // Background
            const bg = gfx.createGraphics();
            bg.rect(0, 0, CONFIG.width, CONFIG.height);
            bg.fill({ color: 0x0a0a20 });
            worldContainer.addChild(bg);

            // Create stars
            createStars();

            // Create player (hidden initially)
            createPlayer();
            player.visible = false;

            // UI Container
            uiContainer = gfx.createContainer();
            mainContainer.addChild(uiContainer);

            // === FRAMEWORK COMPONENT: SplashScreen ===
            showSplashScreen();

            // === FRAMEWORK COMPONENT: CelebrationManager ===
            celebrationManager = new CelebrationManager(worldContainer, {
                width: CONFIG.width,
                height: CONFIG.height,
                maxParticles: 150,
                particleSpeed: { min: 3, max: 8 },
                gravity: 0.3
            });

            // Keyboard input
            setupInput();

            // Game loop
            game.on('update', (dt) => {
                if (gameState === 'playing') {
                    updateGame(dt);
                }

                // Update celebration effects
                celebrationManager.update(dt);
            });

            window.addEventListener('resize', handleResize);
            game.start();
        }

        // === SPLASH SCREEN ===
        function showSplashScreen() {
            splashScreen = new SplashScreen({
                title: 'SPACE SHOOTER',
                subtitle: 'Defend the Galaxy',
                backgroundColor: 0x0a0a20,
                titleColor: 0x3498DB,
                subtitleColor: 0x5DADE2,
                onComplete: () => {
                    if (splashScreen) {
                        uiContainer.removeChild(splashScreen.getContainer());
                        splashScreen = null;
                    }
                    showMainMenu();
                }
            });

            splashScreen.setPosition(
                (CONFIG.width - splashScreen.getWidth()) / 2,
                (CONFIG.height - splashScreen.getHeight()) / 2
            );
            uiContainer.addChild(splashScreen.getContainer());
            splashScreen.show();
        }

        // === MAIN MENU ===
        function showMainMenu() {
            gameState = 'menu';

            // Menu container
            mainMenu = gfx.createContainer();

            // Title
            const title = gfx.createText('SPACE SHOOTER', {
                fontSize: 48,
                fill: 0x3498DB,
                fontWeight: 'bold',
                align: 'center'
            });
            title.anchor.set(0.5, 0.5);
            title.x = CONFIG.width / 2;
            title.y = CONFIG.height / 3;
            mainMenu.addChild(title);

            // Subtitle
            const subtitle = gfx.createText('Defend the Galaxy', {
                fontSize: 20,
                fill: 0x5DADE2,
                align: 'center'
            });
            subtitle.anchor.set(0.5, 0.5);
            subtitle.x = CONFIG.width / 2;
            subtitle.y = CONFIG.height / 3 + 60;
            mainMenu.addChild(subtitle);

            // Play button
            const playButton = new GameStyleButton({
                text: 'PLAY',
                width: 200,
                height: 60,
                fontSize: 24,
                colorScheme: GameStyleColors.GREEN_BUTTON,
                cornerRadius: 10
            });
            playButton.setPosition(
                (CONFIG.width - 200) / 2,
                CONFIG.height / 2 + 40
            );
            playButton.on('click', startGame);
            mainMenu.addChild(playButton.getContainer());

            // Instructions text
            const instructions = gfx.createText(
                'Arrow Keys or WASD to Move\nSpace to Fire',
                {
                    fontSize: 16,
                    fill: 0x95A5A6,
                    align: 'center'
                }
            );
            instructions.anchor.set(0.5, 0.5);
            instructions.x = CONFIG.width / 2;
            instructions.y = CONFIG.height - 100;
            mainMenu.addChild(instructions);

            uiContainer.addChild(mainMenu);
        }

        // === START GAME ===
        function startGame() {
            if (mainMenu) {
                uiContainer.removeChild(mainMenu);
                mainMenu = null;
            }

            gameState = 'playing';
            player.visible = true;

            // === FRAMEWORK COMPONENT: GameTopBar ===
            topBar = new GameTopBar({
                width: CONFIG.width - 20,
                height: 50,
                resources: [
                    { type: 'lives', value: lives, maxValue: 3, icon: 'heart' },
                    { type: 'coins', value: score, icon: 'star', label: 'Score' }
                ],
                showSettings: false,
                backgroundColor: 0x000000,
                backgroundAlpha: 0.5
            });
            topBar.setPosition(10, 5);
            uiContainer.addChild(topBar.getContainer());

            // Wave indicator
            const waveText = gfx.createText(`Wave ${wave}`, {
                fontSize: 16,
                fill: 0xF39C12,
                fontWeight: 'bold'
            });
            waveText.anchor.set(0.5, 0);
            waveText.x = CONFIG.width / 2;
            waveText.y = 60;
            uiContainer.addChild(waveText);
            uiContainer.waveText = waveText;

            // === FRAMEWORK COMPONENT: Mobile Controls ===
            if ('ontouchstart' in window) {
                // VirtualJoystick for movement
                joystick = new VirtualJoystick({
                    mode: 'fixed',
                    baseRadius: 50,
                    stickRadius: 22,
                    position: { x: 70, y: CONFIG.height - 90 },
                    style: {
                        baseColor: 0x333366,
                        baseAlpha: 0.6,
                        stickColor: 0x6666FF,
                        stickAlpha: 0.9
                    }
                });
                uiContainer.addChild(joystick.getContainer());

                joystick.on('move', (data) => {
                    keys.left = data.vector.x < -0.3;
                    keys.right = data.vector.x > 0.3;
                    keys.up = data.vector.y < -0.3;
                    keys.down = data.vector.y > 0.3;
                });

                joystick.on('end', () => {
                    keys.left = keys.right = keys.up = keys.down = false;
                });

                // GameStyleButton for fire
                fireButton = new GameStyleButton({
                    text: 'FIRE',
                    width: 80,
                    height: 80,
                    fontSize: 16,
                    colorScheme: GameStyleColors.RED_BUTTON,
                    cornerRadius: 40
                });
                fireButton.setPosition(CONFIG.width - 100, CONFIG.height - 110);
                fireButton.on('pointerdown', () => { keys.fire = true; });
                fireButton.on('pointerup', () => { keys.fire = false; });
                fireButton.on('pointerupoutside', () => { keys.fire = false; });
                uiContainer.addChild(fireButton.getContainer());
            }

            // Spawn first wave
            spawnWave();
        }

        function createStars() {
            for (let i = 0; i < 80; i++) {
                const star = gfx.createGraphics();
                const size = Math.random() * 2 + 0.5;
                star.circle(0, 0, size);
                star.fill({ color: 0xFFFFFF, alpha: Math.random() * 0.5 + 0.3 });
                star.x = Math.random() * CONFIG.width;
                star.y = Math.random() * CONFIG.height;
                star.speed = Math.random() * 1.5 + 0.5;
                worldContainer.addChild(star);
                stars.push(star);
            }
        }

        function createPlayer() {
            player = gfx.createContainer();

            // Ship body
            const body = gfx.createGraphics();
            body.poly([0, -20, -15, 15, 0, 8, 15, 15]);
            body.fill({ color: 0x3498DB });
            body.stroke({ color: 0x2980B9, width: 2 });
            player.addChild(body);

            // Cockpit
            const cockpit = gfx.createGraphics();
            cockpit.ellipse(0, -5, 5, 8);
            cockpit.fill({ color: 0x5DADE2 });
            player.addChild(cockpit);

            // Engine glow
            playerEngine = gfx.createGraphics();
            playerEngine.poly([-8, 15, 0, 28, 8, 15]);
            playerEngine.fill({ color: 0xF39C12 });
            player.addChild(playerEngine);

            player.x = CONFIG.width / 2;
            player.y = CONFIG.height - 80;
            worldContainer.addChild(player);
        }

        function setupInput() {
            window.addEventListener('keydown', (e) => {
                if (gameState !== 'playing') return;
                if (e.code === 'ArrowLeft' || e.code === 'KeyA') keys.left = true;
                if (e.code === 'ArrowRight' || e.code === 'KeyD') keys.right = true;
                if (e.code === 'ArrowUp' || e.code === 'KeyW') keys.up = true;
                if (e.code === 'ArrowDown' || e.code === 'KeyS') keys.down = true;
                if (e.code === 'Space') keys.fire = true;
                if (['Space', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.code)) {
                    e.preventDefault();
                }
            });

            window.addEventListener('keyup', (e) => {
                if (e.code === 'ArrowLeft' || e.code === 'KeyA') keys.left = false;
                if (e.code === 'ArrowRight' || e.code === 'KeyD') keys.right = false;
                if (e.code === 'ArrowUp' || e.code === 'KeyW') keys.up = false;
                if (e.code === 'ArrowDown' || e.code === 'KeyS') keys.down = false;
                if (e.code === 'Space') keys.fire = false;
            });
        }

        function spawnWave() {
            const enemyCount = 3 + wave * 2;
            const rows = Math.ceil(enemyCount / 5);

            for (let row = 0; row < rows; row++) {
                const inRow = Math.min(5, enemyCount - row * 5);
                const startX = (CONFIG.width - (inRow - 1) * 80) / 2;

                for (let col = 0; col < inRow; col++) {
                    createEnemy(startX + col * 80, -50 - row * 50, row % 3);
                }
            }

            uiContainer.waveText.text = `Wave ${wave}`;
        }

        function createEnemy(x, y, type) {
            const enemy = gfx.createContainer();
            const colors = [0xE74C3C, 0x9B59B6, 0x1ABC9C];
            const sizes = [15, 18, 22];

            const body = gfx.createGraphics();
            if (type === 0) {
                body.poly([0, sizes[type], -sizes[type], -sizes[type], sizes[type], -sizes[type]]);
            } else if (type === 1) {
                body.rect(-sizes[type], -sizes[type]/2, sizes[type]*2, sizes[type]);
            } else {
                body.circle(0, 0, sizes[type]);
            }
            body.fill({ color: colors[type] });
            body.stroke({ color: 0xFFFFFF, width: 2, alpha: 0.5 });
            enemy.addChild(body);

            enemy.x = x;
            enemy.y = y;
            enemy.type = type;
            enemy.health = type + 1;
            enemy.speed = 1 + wave * 0.2;
            enemy.shootCooldown = 0;
            enemy.moveDir = 1;

            worldContainer.addChild(enemy);
            enemies.push(enemy);
        }

        function shoot() {
            const now = Date.now();
            if (now - lastShot < 180) return;
            lastShot = now;

            const bullet = gfx.createGraphics();
            bullet.roundRect(-3, -8, 6, 16, 2);
            bullet.fill({ color: 0x00FF00 });
            bullet.x = player.x;
            bullet.y = player.y - 20;
            worldContainer.addChild(bullet);
            bullets.push(bullet);
        }

        function enemyShoot(enemy) {
            const bullet = gfx.createGraphics();
            bullet.circle(0, 0, 5);
            bullet.fill({ color: 0xFF3333 });
            bullet.x = enemy.x;
            bullet.y = enemy.y + 20;
            worldContainer.addChild(bullet);
            enemyBullets.push(bullet);
        }

        function createExplosion(x, y, color) {
            for (let i = 0; i < 10; i++) {
                const particle = gfx.createGraphics();
                particle.circle(0, 0, Math.random() * 4 + 2);
                particle.fill({ color });
                particle.x = x;
                particle.y = y;
                particle.vx = (Math.random() - 0.5) * 8;
                particle.vy = (Math.random() - 0.5) * 8;
                particle.life = 1;
                worldContainer.addChild(particle);
                explosions.push(particle);
            }
        }

        function updateGame(dt) {
            // Player movement
            if (keys.left) player.x -= CONFIG.playerSpeed;
            if (keys.right) player.x += CONFIG.playerSpeed;
            if (keys.up) player.y -= CONFIG.playerSpeed * 0.7;
            if (keys.down) player.y += CONFIG.playerSpeed * 0.7;
            if (keys.fire) shoot();

            player.x = Math.max(20, Math.min(CONFIG.width - 20, player.x));
            player.y = Math.max(CONFIG.height / 2, Math.min(CONFIG.height - 40, player.y));

            // Engine animation
            playerEngine.scale.y = 0.8 + Math.sin(Date.now() / 50) * 0.3;

            // Invincibility
            if (playerInvincible > 0) {
                playerInvincible--;
                player.alpha = Math.sin(Date.now() / 50) > 0 ? 1 : 0.3;
            } else {
                player.alpha = 1;
            }

            // Update stars
            stars.forEach(star => {
                star.y += star.speed;
                if (star.y > CONFIG.height) star.y = 0;
            });

            // Update player bullets
            for (let i = bullets.length - 1; i >= 0; i--) {
                bullets[i].y -= CONFIG.bulletSpeed;
                if (bullets[i].y < -20) {
                    worldContainer.removeChild(bullets[i]);
                    bullets.splice(i, 1);
                }
            }

            // Update enemy bullets
            for (let i = enemyBullets.length - 1; i >= 0; i--) {
                enemyBullets[i].y += CONFIG.enemyBulletSpeed;

                if (enemyBullets[i].y > CONFIG.height + 20) {
                    worldContainer.removeChild(enemyBullets[i]);
                    enemyBullets.splice(i, 1);
                    continue;
                }

                // Hit player
                if (playerInvincible <= 0) {
                    const dx = enemyBullets[i].x - player.x;
                    const dy = enemyBullets[i].y - player.y;
                    if (Math.sqrt(dx * dx + dy * dy) < 20) {
                        worldContainer.removeChild(enemyBullets[i]);
                        enemyBullets.splice(i, 1);
                        hitPlayer();
                    }
                }
            }

            // Update enemies
            enemies.forEach(enemy => {
                if (enemy.y < 80 + enemy.type * 30) {
                    enemy.y += 2;
                } else {
                    enemy.x += enemy.moveDir * enemy.speed;
                    if (enemy.x < 30 || enemy.x > CONFIG.width - 30) {
                        enemy.moveDir *= -1;
                        enemy.y += 15;
                    }
                }

                enemy.shootCooldown--;
                if (enemy.shootCooldown <= 0 && Math.random() < 0.02) {
                    enemyShoot(enemy);
                    enemy.shootCooldown = 60;
                }

                enemy.rotation += 0.02;

                // Enemy reached bottom
                if (enemy.y > CONFIG.height - 60) {
                    gameOver();
                }
            });

            // Bullet-enemy collision
            for (let i = bullets.length - 1; i >= 0; i--) {
                for (let j = enemies.length - 1; j >= 0; j--) {
                    const dx = bullets[i].x - enemies[j].x;
                    const dy = bullets[i].y - enemies[j].y;
                    if (Math.sqrt(dx * dx + dy * dy) < 25) {
                        worldContainer.removeChild(bullets[i]);
                        bullets.splice(i, 1);

                        enemies[j].health--;
                        if (enemies[j].health <= 0) {
                            createExplosion(enemies[j].x, enemies[j].y, 0xE74C3C);

                            // Confetti effect on kill
                            celebrationManager.burst({
                                x: enemies[j].x,
                                y: enemies[j].y,
                                particleCount: 15,
                                colors: [0xE74C3C, 0x9B59B6, 0xF39C12, 0x3498DB]
                            });

                            worldContainer.removeChild(enemies[j]);
                            enemies.splice(j, 1);
                            score += 100 * wave;
                            topBar.updateResource('coins', score);
                        } else {
                            enemies[j].scale.set(1.2);
                            setTimeout(() => { if (enemies[j]) enemies[j].scale.set(1); }, 100);
                        }
                        break;
                    }
                }
            }

            // Enemy-player collision
            if (playerInvincible <= 0) {
                for (let enemy of enemies) {
                    const dx = enemy.x - player.x;
                    const dy = enemy.y - player.y;
                    if (Math.sqrt(dx * dx + dy * dy) < 30) {
                        hitPlayer();
                        break;
                    }
                }
            }

            // Update explosions
            for (let i = explosions.length - 1; i >= 0; i--) {
                const p = explosions[i];
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.03;
                p.alpha = p.life;
                if (p.life <= 0) {
                    worldContainer.removeChild(p);
                    explosions.splice(i, 1);
                }
            }

            // Next wave
            if (enemies.length === 0) {
                wave++;
                uiContainer.waveText.text = `Wave ${wave}`;

                // Celebration for completing wave
                celebrationManager.fullScreen({
                    duration: 1500,
                    particleCount: 50,
                    colors: [0x00FF00, 0x3498DB, 0xF39C12]
                });

                spawnWave();
            }
        }

        function hitPlayer() {
            lives--;
            topBar.updateResource('lives', lives);
            playerInvincible = 120;
            createExplosion(player.x, player.y, 0x3498DB);

            if (lives <= 0) {
                gameOver();
            }
        }

        function gameOver() {
            gameState = 'gameover';

            // === FRAMEWORK COMPONENT: ResultScreen ===
            resultScreen = new ResultScreen({
                type: 'defeat',
                title: 'GAME OVER',
                subtitle: `Wave ${wave} reached`,
                score: score,
                stars: Math.min(3, Math.floor(wave / 3)),
                rewards: [
                    { icon: 'â­', label: 'Score', value: score },
                    { icon: 'ðŸŒŠ', label: 'Wave', value: wave }
                ],
                actions: [
                    { id: 'replay', label: 'PLAY AGAIN', primary: true }
                ],
                onAction: (actionId) => {
                    if (actionId === 'replay') {
                        restartGame();
                    }
                }
            });

            resultScreen.setPosition(
                (CONFIG.width - 320) / 2,
                (CONFIG.height - 400) / 2
            );
            uiContainer.addChild(resultScreen.getContainer());
        }

        function restartGame() {
            if (resultScreen) {
                resultScreen.getContainer().parent?.removeChild(resultScreen.getContainer());
                resultScreen = null;
            }

            // Clear game elements
            bullets.forEach(b => worldContainer.removeChild(b));
            enemyBullets.forEach(b => worldContainer.removeChild(b));
            enemies.forEach(e => worldContainer.removeChild(e));
            explosions.forEach(p => worldContainer.removeChild(p));

            bullets = [];
            enemyBullets = [];
            enemies = [];
            explosions = [];

            // Clear UI components
            if (topBar) {
                uiContainer.removeChild(topBar.getContainer());
                topBar = null;
            }

            if (uiContainer.waveText) {
                uiContainer.removeChild(uiContainer.waveText);
                uiContainer.waveText = null;
            }

            if (joystick) {
                uiContainer.removeChild(joystick.getContainer());
                joystick = null;
            }

            if (fireButton) {
                uiContainer.removeChild(fireButton.getContainer());
                fireButton = null;
            }

            // Reset state
            score = 0;
            lives = 3;
            wave = 1;
            playerInvincible = 0;

            player.x = CONFIG.width / 2;
            player.y = CONFIG.height - 80;
            player.alpha = 1;

            // Return to main menu
            gameState = 'menu';
            player.visible = false;
            showMainMenu();
        }

        function handleResize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const renderer = game.make('renderer');
            renderer.resize(window.innerWidth, window.innerHeight);

            const scaleX = window.innerWidth / CONFIG.width;
            const scaleY = window.innerHeight / CONFIG.height;
            const scale = Math.min(scaleX, scaleY);

            mainContainer.scale.set(scale);
            mainContainer.x = (window.innerWidth - CONFIG.width * scale) / 2;
            mainContainer.y = (window.innerHeight - CONFIG.height * scale) / 2;
        }

        init().catch(console.error);
    </script>
</body>
</html>

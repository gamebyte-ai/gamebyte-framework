<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HubScreen Demo - GameByte Framework</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { overflow: hidden; background: #1a1a2e; transition: background 0.3s ease; }
        body.light-theme { background: #e8eef5; }
        canvas { display: block; margin: 0 auto; }
    </style>
</head>
<body>
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@8/dist/pixi.min.js"></script>
    <script src="/gamebyte.umd.js"></script>

    <script>
        // =====================================================
        // HubScreen Framework Demo
        // =====================================================
        // This demo showcases the HubScreen framework component:
        // - HubScreen with GameTopBar and GameBottomNav
        // - Resource displays for coins and gems
        // - Tab-based navigation (Shop, Play, Profile)
        // - Proper use of registerTabContent() API
        // - Framework graphics abstraction
        // - CelebrationManager integration
        // =====================================================

        const {
            createGame,
            HubScreen,
            CelebrationManager,
            graphics,
            loadFrameworkFont,
            getFrameworkFontFamily
        } = GameByteFramework;

        const CONFIG = { width: 360, height: 640 };

        // ===== THEME DETECTION =====
        function detectTheme() {
            try {
                if (window.parent && window.parent.document) {
                    const parentTheme = window.parent.document.documentElement.getAttribute('data-theme');
                    if (parentTheme) return parentTheme;
                }
            } catch (e) { /* Cross-origin */ }

            const urlParams = new URLSearchParams(window.location.search);
            const themeParam = urlParams.get('theme');
            if (themeParam) return themeParam;

            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
                return 'light';
            }
            return 'dark';
        }

        let currentTheme = detectTheme();

        function setupThemeListener() {
            try {
                if (window.parent && window.parent.document) {
                    const observer = new MutationObserver((mutations) => {
                        mutations.forEach((mutation) => {
                            if (mutation.attributeName === 'data-theme') {
                                const newTheme = window.parent.document.documentElement.getAttribute('data-theme');
                                if (newTheme && newTheme !== currentTheme) {
                                    currentTheme = newTheme;
                                    applyTheme();
                                }
                            }
                        });
                    });
                    observer.observe(window.parent.document.documentElement, { attributes: true });
                }
            } catch (e) {
                window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', (e) => {
                    currentTheme = e.matches ? 'light' : 'dark';
                    applyTheme();
                });
            }
        }

        // ===== THEME COLOR PALETTES =====
        const THEME_COLORS = {
            dark: {
                bgDark: 0x1a1a2e,
                cardBg: 0x2d2d44,
                cardShadow: 0x1a1a2e,
                coinColor: 0xFFD700,
                gemColor: 0x00BFFF,
                playBtnGlow: 0x4CAF50,
                playBtnShadow: 0x2E7D32,
                playBtn: 0x4CAF50,
                buyBtn: 0x4CAF50,
                avatarGlow: 0x6366f1,
                avatarBg: 0x6366f1,
                textWhite: 0xffffff,
                textMuted: 0x888888
            },
            light: {
                bgDark: 0xe8eef5,
                cardBg: 0xd0d8e8,
                cardShadow: 0xc0c8d0,
                coinColor: 0xD4A000,
                gemColor: 0x0090C0,
                playBtnGlow: 0x3d9d40,
                playBtnShadow: 0x2d7d30,
                playBtn: 0x4CAF50,
                buyBtn: 0x4CAF50,
                avatarGlow: 0x7376f8,
                avatarBg: 0x7376f8,
                textWhite: 0xffffff,
                textMuted: 0x5a6a7a
            }
        };

        function getColors() {
            return THEME_COLORS[currentTheme] || THEME_COLORS.dark;
        }

        const canvas = document.createElement('canvas');
        canvas.width = CONFIG.width;
        canvas.height = CONFIG.height;
        document.body.appendChild(canvas);

        const game = createGame();

        let coins = 1234;
        let gems = 50;
        let celebration = null;
        let renderer, stage, hubScreen;

        let isRecreating = false;
        async function applyTheme() {
            if (isRecreating) return;
            isRecreating = true;

            document.body.classList.toggle('light-theme', currentTheme === 'light');
            if (stage && window.createHubUI) {
                await loadFrameworkFont();
                window.createHubUI();
            }
            setTimeout(() => { isRecreating = false; }, 100);
        }

        (async () => {
            await loadFrameworkFont();
            await game.initialize(canvas, '2d');
            renderer = game.make('renderer');
            stage = renderer.getStage();

            celebration = new CelebrationManager(stage, CONFIG.width, CONFIG.height);

            setupThemeListener();

            function createHubUI() {
                const colors = getColors();
                const gfx = graphics();

                // Clear stage
                while (stage.children.length > 0) {
                    stage.removeChildAt(0);
                }
                celebration.clear();

                // Destroy previous hub screen
                if (hubScreen) {
                    hubScreen.destroy();
                }

                // Create HubScreen with configuration
                hubScreen = new HubScreen({
                    backgroundColor: colors.bgDark,
                    topBarResources: [
                        {
                            type: 'coins',
                            value: coins,
                            icon: 'coin',
                            iconColor: colors.coinColor,
                            showAddButton: true,
                            onAddClick: () => {
                                coins += 100;
                                hubScreen.updateResource('coins', coins);
                                celebration.sparkle(CONFIG.width / 2, 30);
                            }
                        },
                        {
                            type: 'gems',
                            value: gems,
                            icon: 'gem',
                            iconColor: colors.gemColor
                        }
                    ],
                    showSettings: true,
                    onSettingsClick: () => {
                        console.log('Settings clicked');
                        celebration.confettiBurst(35, 35, {
                            particleCount: 20,
                            colors: [0x6366f1, 0x8b5cf6]
                        });
                    },
                    bottomNavItems: [
                        { id: 'shop', type: 'shop', label: 'Shop' },
                        { id: 'play', type: 'play', label: 'Play', highlighted: true },
                        { id: 'profile', type: 'profile', label: 'Profile', locked: true }
                    ],
                    defaultTab: 'play'
                });

                // Register tab contents
                hubScreen.registerTabContent('shop', () => createShopTab(colors, gfx));
                hubScreen.registerTabContent('play', () => createPlayTab(colors, gfx));
                hubScreen.registerTabContent('profile', () => createProfileTab(colors, gfx));

                // Listen for tab changes
                hubScreen.on('tab-changed', (tabId) => {
                    console.log('Tab switched to:', tabId);
                });

                // Initialize and add to stage
                hubScreen.resize(CONFIG.width, CONFIG.height);
                stage.addChild(hubScreen.getContainer());
            }

            // ===== TAB CONTENT CREATORS =====

            function createShopTab(colors, gfx) {
                const content = gfx.createContainer();
                const { width, height } = hubScreen.getContentAreaSize();

                const title = gfx.createText('ðŸ›’ Shop', {
                    fontFamily: getFrameworkFontFamily(),
                    fontSize: 28,
                    fontWeight: 'bold',
                    fill: colors.textWhite
                });
                title.x = 20;
                title.y = 20;
                content.addChild(title);

                const items = [
                    { name: '100 Coins', price: 'ðŸ’Ž 10', color: colors.coinColor, type: 'gold' },
                    { name: '500 Coins', price: 'ðŸ’Ž 45', color: colors.coinColor, type: 'gold' },
                    { name: 'No Ads', price: '$2.99', color: 0x4CAF50, type: 'none' }
                ];

                items.forEach((item, i) => {
                    const cardShadow = gfx.createGraphics();
                    cardShadow.roundRect(20, 75 + i * 100, width - 40, 80, 12);
                    cardShadow.fill(colors.cardShadow);
                    content.addChild(cardShadow);

                    const card = gfx.createGraphics();
                    card.roundRect(20, 70 + i * 100, width - 40, 80, 12);
                    card.fill(colors.cardBg);
                    card.eventMode = 'static';
                    card.cursor = 'pointer';
                    content.addChild(card);

                    if (item.type === 'gold') {
                        const iconContainer = gfx.createContainer();
                        iconContainer.x = 55;
                        iconContainer.y = 110 + i * 100;
                        content.addChild(iconContainer);

                        const itemIcon = gfx.createText('ðŸª™', { fontSize: 28 });
                        itemIcon.anchor.set(0.5);
                        iconContainer.addChild(itemIcon);

                        celebration.addShimmer(iconContainer, 'gold');
                    }

                    const name = gfx.createText(item.name, {
                        fontFamily: getFrameworkFontFamily(),
                        fontSize: 18,
                        fontWeight: 'bold',
                        fill: item.color
                    });
                    name.x = item.type === 'gold' ? 85 : 40;
                    name.y = 95 + i * 100;
                    content.addChild(name);

                    const buyBtn = gfx.createGraphics();
                    buyBtn.roundRect(width - 100, 85 + i * 100, 60, 30, 8);
                    buyBtn.fill(colors.buyBtn);
                    content.addChild(buyBtn);

                    const price = gfx.createText(item.price, {
                        fontFamily: getFrameworkFontFamily(),
                        fontSize: 12,
                        fill: colors.textWhite
                    });
                    price.anchor.set(0.5);
                    price.x = width - 70;
                    price.y = 100 + i * 100;
                    content.addChild(price);

                    card.on('pointerdown', () => {
                        celebration.sparkle(width / 2, 110 + i * 100);
                    });
                });

                return content;
            }

            function createPlayTab(colors, gfx) {
                const content = gfx.createContainer();
                const { width, height } = hubScreen.getContentAreaSize();

                const title = gfx.createText('ðŸŽ® Ready to Play!', {
                    fontFamily: getFrameworkFontFamily(),
                    fontSize: 24,
                    fontWeight: 'bold',
                    fill: colors.textWhite
                });
                title.anchor.set(0.5);
                title.x = width / 2;
                title.y = 120;
                content.addChild(title);

                const playBtnGlow = gfx.createGraphics();
                playBtnGlow.roundRect(55, 175, width - 110, 90, 20);
                playBtnGlow.fill({ color: colors.playBtnGlow, alpha: 0.3 });
                content.addChild(playBtnGlow);

                const playBtnShadow = gfx.createGraphics();
                playBtnShadow.roundRect(60, 185, width - 120, 80, 16);
                playBtnShadow.fill(colors.playBtnShadow);
                content.addChild(playBtnShadow);

                const playBtn = gfx.createGraphics();
                playBtn.roundRect(60, 180, width - 120, 80, 16);
                playBtn.fill(colors.playBtn);
                playBtn.eventMode = 'static';
                playBtn.cursor = 'pointer';
                content.addChild(playBtn);

                const playText = gfx.createText('â–¶  PLAY', {
                    fontFamily: getFrameworkFontFamily(),
                    fontSize: 28,
                    fontWeight: 'bold',
                    fill: colors.textWhite
                });
                playText.anchor.set(0.5);
                playText.x = width / 2;
                playText.y = 220;
                content.addChild(playText);

                playBtn.on('pointerdown', () => {
                    celebration.confettiBurst(width / 2, 220, {
                        particleCount: 30,
                        colors: [0x4CAF50, 0x6BCB77, 0xFFD700]
                    });
                });

                const levelText = gfx.createText('Level 5', {
                    fontFamily: getFrameworkFontFamily(),
                    fontSize: 18,
                    fill: colors.textMuted
                });
                levelText.anchor.set(0.5);
                levelText.x = width / 2;
                levelText.y = 300;
                content.addChild(levelText);

                const starsContainer = gfx.createContainer();
                starsContainer.x = width / 2;
                starsContainer.y = 340;
                content.addChild(starsContainer);

                for (let i = 0; i < 3; i++) {
                    const starContainer = gfx.createContainer();
                    starContainer.x = (i - 1) * 40;
                    starsContainer.addChild(starContainer);

                    const star = gfx.createText(i < 2 ? 'â­' : 'â˜†', { fontSize: 28 });
                    star.anchor.set(0.5);
                    starContainer.addChild(star);

                    if (i < 2) {
                        celebration.addShimmer(starContainer, 'star');
                    }
                }

                return content;
            }

            function createProfileTab(colors, gfx) {
                const content = gfx.createContainer();
                const { width, height } = hubScreen.getContentAreaSize();

                const avatarGlow = gfx.createGraphics();
                avatarGlow.circle(width / 2, 100, 55);
                avatarGlow.fill({ color: colors.avatarGlow, alpha: 0.3 });
                content.addChild(avatarGlow);

                const avatar = gfx.createGraphics();
                avatar.circle(width / 2, 100, 50);
                avatar.fill(colors.avatarBg);
                content.addChild(avatar);

                const avatarIcon = gfx.createText('ðŸ‘¤', { fontSize: 48 });
                avatarIcon.anchor.set(0.5);
                avatarIcon.x = width / 2;
                avatarIcon.y = 100;
                content.addChild(avatarIcon);

                const name = gfx.createText('Player123', {
                    fontFamily: getFrameworkFontFamily(),
                    fontSize: 24,
                    fontWeight: 'bold',
                    fill: colors.textWhite
                });
                name.anchor.set(0.5);
                name.x = width / 2;
                name.y = 180;
                content.addChild(name);

                const stats = gfx.createText('Games: 42  |  Best: 12,450', {
                    fontFamily: getFrameworkFontFamily(),
                    fontSize: 14,
                    fill: colors.textMuted
                });
                stats.anchor.set(0.5);
                stats.x = width / 2;
                stats.y = 220;
                content.addChild(stats);

                const achieveTitle = gfx.createText('Achievements', {
                    fontFamily: getFrameworkFontFamily(),
                    fontSize: 18,
                    fontWeight: 'bold',
                    fill: colors.textWhite
                });
                achieveTitle.x = 20;
                achieveTitle.y = 270;
                content.addChild(achieveTitle);

                const badges = ['ðŸ†', 'ðŸŽ¯', 'âš¡'];
                badges.forEach((badge, i) => {
                    const badgeContainer = gfx.createContainer();
                    badgeContainer.x = 50 + i * 60;
                    badgeContainer.y = 320;
                    content.addChild(badgeContainer);

                    const badgeBg = gfx.createGraphics();
                    badgeBg.circle(0, 0, 25);
                    badgeBg.fill(colors.cardBg);
                    badgeContainer.addChild(badgeBg);

                    const badgeIcon = gfx.createText(badge, { fontSize: 24 });
                    badgeIcon.anchor.set(0.5);
                    badgeContainer.addChild(badgeIcon);

                    celebration.addShimmer(badgeContainer, 'gold');
                });

                return content;
            }

            window.createHubUI = createHubUI;

            game.on('update', (deltaTime) => {
                celebration.update(deltaTime);
            });

            document.body.classList.toggle('light-theme', currentTheme === 'light');
            createHubUI();
            game.start();
        })();
    </script>
</body>
</html>

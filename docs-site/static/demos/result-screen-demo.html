<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ResultScreen Demo - GameByte Framework</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { overflow: hidden; background: #1c2333; transition: background 0.3s ease; }
        body.light-theme { background: #e8eef5; }
        canvas { display: block; margin: 0 auto; }
    </style>
</head>
<body>
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@8/dist/pixi.min.js"></script>
    <script src="/gamebyte.umd.js"></script>

    <script>
        // =====================================================
        // ResultScreen Demo - Using Framework Abstractions
        // =====================================================
        // This demo showcases:
        // - Victory/Result screen with trophy and rewards
        // - Light rays and glow effects
        // - CelebrationManager for confetti
        // - graphics() abstraction instead of direct PIXI usage
        // =====================================================

        const {
            createGame,
            CelebrationManager,
            graphics,
            loadFrameworkFont
        } = GameByteFramework;

        const CONFIG = { width: 360, height: 700 };

        // ===== THEME DETECTION =====
        function detectTheme() {
            try {
                if (window.parent && window.parent.document) {
                    const parentTheme = window.parent.document.documentElement.getAttribute('data-theme');
                    if (parentTheme) return parentTheme;
                }
            } catch (e) { /* Cross-origin */ }

            const urlParams = new URLSearchParams(window.location.search);
            const themeParam = urlParams.get('theme');
            if (themeParam) return themeParam;

            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
                return 'light';
            }
            return 'dark';
        }

        let currentTheme = detectTheme();

        function setupThemeListener() {
            try {
                if (window.parent && window.parent.document) {
                    const observer = new MutationObserver((mutations) => {
                        mutations.forEach((mutation) => {
                            if (mutation.attributeName === 'data-theme') {
                                const newTheme = window.parent.document.documentElement.getAttribute('data-theme');
                                if (newTheme && newTheme !== currentTheme) {
                                    currentTheme = newTheme;
                                    applyTheme();
                                }
                            }
                        });
                    });
                    observer.observe(window.parent.document.documentElement, { attributes: true });
                }
            } catch (e) {
                window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', (e) => {
                    currentTheme = e.matches ? 'light' : 'dark';
                    applyTheme();
                });
            }
        }

        // ===== THEME COLOR PALETTES =====
        const THEME_COLORS = {
            dark: {
                darkBg: 0x1c2333,
                rayColor: 0x2a3f5f,
                rayAlpha: 0.35,
                glowOuter: 0xa5a845,
                glowMiddle: 0xb8b850,
                glowInner: 0xd4d870,
                panelBg: 0x4a7ab5,
                panelBorder: 0x2a4a75,
                panelGradientBottom: 0x3a6a95,
                bannerBlue: 0x5ab0e8,
                bannerLight: 0x7ac8f8,
                bannerDark: 0x3a90c8,
                rewardPanelBg: 0x5a8ab8,
                rewardPanelBorder: 0x3a5a85,
                greenBtn: 0x6ac46a,
                greenBtnShadow: 0x3a8a3a,
                greenBtnHighlight: 0x8ae88a,
                orangeBtn: 0xe8c878,
                orangeBtnShadow: 0xc8a050,
                orangeBtnHighlight: 0xf8e0a0,
                textWhite: 0xffffff,
                textOutline: 0x2a4a6a,
                textDark: 0x4a5a6a,
                coinDisplayBg: 0x3a4a6a,
                plusButton: 0xe8a040
            },
            light: {
                darkBg: 0xe8eef5,
                rayColor: 0xc5d5e8,
                rayAlpha: 0.5,
                glowOuter: 0xf5d060,
                glowMiddle: 0xffd700,
                glowInner: 0xffec80,
                panelBg: 0x6a9fd8,
                panelBorder: 0x4a7ab5,
                panelGradientBottom: 0x5a90c8,
                bannerBlue: 0x60b8f0,
                bannerLight: 0x90d0ff,
                bannerDark: 0x4a98d0,
                rewardPanelBg: 0x7aa8d0,
                rewardPanelBorder: 0x5a88b8,
                greenBtn: 0x5cb85c,
                greenBtnShadow: 0x449d44,
                greenBtnHighlight: 0x8cd98c,
                orangeBtn: 0xf5d070,
                orangeBtnShadow: 0xd4a840,
                orangeBtnHighlight: 0xffe8a0,
                textWhite: 0xffffff,
                textOutline: 0x3a5a7a,
                textDark: 0x3a4a5a,
                coinDisplayBg: 0x5a7a9a,
                plusButton: 0xf0a830
            }
        };

        function getColors() {
            return THEME_COLORS[currentTheme] || THEME_COLORS.dark;
        }

        const canvas = document.createElement('canvas');
        canvas.width = CONFIG.width;
        canvas.height = CONFIG.height;
        document.body.appendChild(canvas);

        const game = createGame();
        let celebration = null;
        let renderer, stage;

        // ===== LIGHT RAYS HELPER =====
        function createLightRays(gfx, config) {
            const colors = getColors();
            const container = gfx.createContainer();
            const {
                rayCount = 16,
                innerRadius = 20,
                outerRadius = 350,
                innerWidth = 0.08,
                outerWidth = 0.12,
                color = colors.rayColor,
                alpha = colors.rayAlpha
            } = config;

            for (let i = 0; i < rayCount; i++) {
                const angle = (i / rayCount) * Math.PI * 2;
                const ray = gfx.createGraphics();

                const innerLeft = {
                    x: Math.cos(angle - innerWidth / 2) * innerRadius,
                    y: Math.sin(angle - innerWidth / 2) * innerRadius
                };
                const innerRight = {
                    x: Math.cos(angle + innerWidth / 2) * innerRadius,
                    y: Math.sin(angle + innerWidth / 2) * innerRadius
                };
                const outerRight = {
                    x: Math.cos(angle + outerWidth / 2) * outerRadius,
                    y: Math.sin(angle + outerWidth / 2) * outerRadius
                };
                const outerLeft = {
                    x: Math.cos(angle - outerWidth / 2) * outerRadius,
                    y: Math.sin(angle - outerWidth / 2) * outerRadius
                };

                ray.poly([
                    innerLeft.x, innerLeft.y,
                    innerRight.x, innerRight.y,
                    outerRight.x, outerRight.y,
                    outerLeft.x, outerLeft.y
                ]);
                ray.fill({ color, alpha });
                container.addChild(ray);
            }

            return container;
        }

        // ===== MULTI-LAYER GLOW HELPER =====
        function createGlow(gfx) {
            const colors = getColors();
            const container = gfx.createContainer();

            const outer = gfx.createGraphics();
            outer.circle(0, 0, 100);
            outer.fill({ color: colors.glowOuter, alpha: 0.25 });
            container.addChild(outer);

            const middle = gfx.createGraphics();
            middle.circle(0, 0, 70);
            middle.fill({ color: colors.glowMiddle, alpha: 0.5 });
            container.addChild(middle);

            const inner = gfx.createGraphics();
            inner.circle(0, 0, 50);
            inner.fill({ color: colors.glowInner, alpha: 0.8 });
            container.addChild(inner);

            return container;
        }

        // ===== 3D BUTTON HELPER =====
        function create3DButton(gfx, x, y, width, height, config) {
            const container = gfx.createContainer();
            const { mainColor, shadowColor, highlightColor } = config;

            const shadow = gfx.createGraphics();
            shadow.roundRect(x, y + 4, width, height, 12);
            shadow.fill(shadowColor);
            container.addChild(shadow);

            const btn = gfx.createGraphics();
            btn.roundRect(x, y, width, height, 12);
            btn.fill(mainColor);
            btn.eventMode = 'static';
            btn.cursor = 'pointer';
            container.addChild(btn);

            const highlight = gfx.createGraphics();
            highlight.roundRect(x + 5, y + 3, width - 10, 15, 8);
            highlight.fill({ color: highlightColor, alpha: 0.4 });
            container.addChild(highlight);

            container.mainBtn = btn;
            return container;
        }

        let isRecreating = false;
        async function applyTheme() {
            if (isRecreating) return;
            isRecreating = true;

            document.body.classList.toggle('light-theme', currentTheme === 'light');
            if (stage && window.createVictoryScreen) {
                await loadFrameworkFont();
                window.createVictoryScreen();
            }
            setTimeout(() => { isRecreating = false; }, 100);
        }

        (async () => {
            await loadFrameworkFont();
            await game.initialize(canvas, '2d');
            renderer = game.make('renderer');
            stage = renderer.getStage();

            celebration = new CelebrationManager(stage, CONFIG.width, CONFIG.height);

            setupThemeListener();

            function createVictoryScreen() {
                const colors = getColors();
                const gfx = graphics();

                while (stage.children.length > 0) {
                    stage.removeChildAt(0);
                }
                celebration.clear();

                const centerX = CONFIG.width / 2;

                // Background
                const bg = gfx.createGraphics();
                bg.rect(0, 0, CONFIG.width, CONFIG.height);
                bg.fill(colors.darkBg);
                stage.addChild(bg);

                // Trophy light rays
                const trophyY = 110;
                const trophyRays = createLightRays(gfx, {
                    rayCount: 16,
                    innerRadius: 15,
                    outerRadius: 350,
                    innerWidth: 0.06,
                    outerWidth: 0.14
                });
                trophyRays.x = centerX;
                trophyRays.y = trophyY + 40;
                stage.addChild(trophyRays);

                game.on('update', () => {
                    trophyRays.rotation += 0.002;
                });

                // Trophy glow
                const trophyGlow = createGlow(gfx);
                trophyGlow.x = centerX;
                trophyGlow.y = trophyY + 40;
                stage.addChild(trophyGlow);

                // Top right coin display
                const coinDisplay = gfx.createContainer();
                coinDisplay.x = CONFIG.width - 80;
                coinDisplay.y = 25;
                stage.addChild(coinDisplay);

                const coinBg = gfx.createGraphics();
                coinBg.roundRect(-50, -15, 100, 30, 15);
                coinBg.fill(colors.coinDisplayBg);
                coinDisplay.addChild(coinBg);

                const coinIcon = gfx.createText('\u{1FA99}', { fontSize: 22 });
                coinIcon.anchor.set(0.5);
                coinIcon.x = -32;
                coinDisplay.addChild(coinIcon);

                const coinAmount = gfx.createText('1460', {
                    fontSize: 16,
                    fontWeight: 'bold',
                    fill: colors.textWhite
                });
                coinAmount.anchor.set(0, 0.5);
                coinAmount.x = -16;
                coinDisplay.addChild(coinAmount);

                const plusBtn = gfx.createGraphics();
                plusBtn.circle(35, 0, 12);
                plusBtn.fill(colors.plusButton);
                coinDisplay.addChild(plusBtn);

                const plusText = gfx.createText('+', {
                    fontSize: 18,
                    fontWeight: 'bold',
                    fill: colors.textWhite
                });
                plusText.anchor.set(0.5);
                plusText.x = 35;
                coinDisplay.addChild(plusText);

                // Main panel
                const panelY = 100;
                const panelWidth = 300;
                const panelHeight = 480;
                const panelX = centerX - panelWidth / 2;

                const panelBorder = gfx.createGraphics();
                panelBorder.roundRect(panelX - 4, panelY - 4, panelWidth + 8, panelHeight + 8, 28);
                panelBorder.fill(colors.panelBorder);
                stage.addChild(panelBorder);

                const panelBg = gfx.createGraphics();
                panelBg.roundRect(panelX, panelY, panelWidth, panelHeight, 25);
                panelBg.fill(colors.panelBg);
                stage.addChild(panelBg);

                const panelGradient = gfx.createGraphics();
                panelGradient.roundRect(panelX, panelY + panelHeight * 0.6, panelWidth, panelHeight * 0.4, 25);
                panelGradient.fill({ color: colors.panelGradientBottom, alpha: 0.4 });
                stage.addChild(panelGradient);

                const panelHighlight = gfx.createGraphics();
                panelHighlight.roundRect(panelX + 10, panelY + 5, panelWidth - 20, 4, 2);
                panelHighlight.fill({ color: 0xffffff, alpha: 0.15 });
                stage.addChild(panelHighlight);

                // Trophy emoji
                const trophy = gfx.createText('\u{1F3C6}', { fontSize: 72 });
                trophy.anchor.set(0.5);
                trophy.x = centerX;
                trophy.y = trophyY + 40;
                stage.addChild(trophy);

                // Level completed banner
                const ribbonY = panelY + 100;
                const ribbonWidth = 260;
                const ribbonHeight = 55;

                const bannerShadow = gfx.createGraphics();
                bannerShadow.roundRect(centerX - ribbonWidth/2, ribbonY + 3, ribbonWidth, ribbonHeight, 8);
                bannerShadow.fill(colors.bannerDark);
                stage.addChild(bannerShadow);

                const banner = gfx.createGraphics();
                banner.roundRect(centerX - ribbonWidth/2, ribbonY, ribbonWidth, ribbonHeight - 3, 8);
                banner.fill(colors.bannerBlue);
                stage.addChild(banner);

                const bannerHighlight = gfx.createGraphics();
                bannerHighlight.roundRect(centerX - ribbonWidth/2 + 5, ribbonY + 2, ribbonWidth - 10, 3, 2);
                bannerHighlight.fill(colors.bannerLight);
                stage.addChild(bannerHighlight);

                // Ribbon ends
                const leftRibbon = gfx.createGraphics();
                leftRibbon.poly([
                    centerX - ribbonWidth/2 - 10, ribbonY + 8,
                    centerX - ribbonWidth/2, ribbonY + 8,
                    centerX - ribbonWidth/2, ribbonY + 47,
                    centerX - ribbonWidth/2 - 10, ribbonY + 47,
                    centerX - ribbonWidth/2, ribbonY + 27
                ]);
                leftRibbon.fill(colors.bannerDark);
                stage.addChild(leftRibbon);

                const rightRibbon = gfx.createGraphics();
                rightRibbon.poly([
                    centerX + ribbonWidth/2 + 10, ribbonY + 8,
                    centerX + ribbonWidth/2, ribbonY + 8,
                    centerX + ribbonWidth/2, ribbonY + 47,
                    centerX + ribbonWidth/2 + 10, ribbonY + 47,
                    centerX + ribbonWidth/2, ribbonY + 27
                ]);
                rightRibbon.fill(colors.bannerDark);
                stage.addChild(rightRibbon);

                // Level text
                const levelText = gfx.createText('LEVEL 20', {
                    fontSize: 24,
                    fontWeight: 'bold',
                    fill: colors.textWhite,
                    dropShadow: true,
                    dropShadowColor: 0x000000,
                    dropShadowDistance: 2,
                    dropShadowBlur: 2
                });
                levelText.anchor.set(0.5);
                levelText.x = centerX;
                levelText.y = ribbonY + 18;
                stage.addChild(levelText);

                const completedText = gfx.createText('COMPLETED!', {
                    fontSize: 12,
                    fontWeight: 'bold',
                    fill: colors.textWhite,
                    dropShadow: true,
                    dropShadowColor: 0x000000,
                    dropShadowDistance: 2,
                    dropShadowBlur: 2
                });
                completedText.anchor.set(0.5);
                completedText.x = centerX;
                completedText.y = ribbonY + 38;
                stage.addChild(completedText);

                // Rewards title
                const rewardsY = ribbonY + 75;
                const rewardsTitle = gfx.createText('REWARDS', {
                    fontSize: 22,
                    fontWeight: 'bold',
                    fill: colors.textWhite,
                    stroke: { color: colors.textOutline, width: 5 }
                });
                rewardsTitle.anchor.set(0.5);
                rewardsTitle.x = centerX;
                rewardsTitle.y = rewardsY;
                stage.addChild(rewardsTitle);

                // Reward panel
                const rewardPanelY = rewardsY + 25;
                const rewardPanelWidth = 260;
                const rewardPanelHeight = 140;
                const rewardPanelX = centerX - rewardPanelWidth / 2;

                const rewardBorder = gfx.createGraphics();
                rewardBorder.roundRect(rewardPanelX - 3, rewardPanelY - 3, rewardPanelWidth + 6, rewardPanelHeight + 6, 18);
                rewardBorder.fill(colors.rewardPanelBorder);
                stage.addChild(rewardBorder);

                const rewardPanel = gfx.createGraphics();
                rewardPanel.roundRect(rewardPanelX, rewardPanelY, rewardPanelWidth, rewardPanelHeight, 15);
                rewardPanel.fill(colors.rewardPanelBg);
                stage.addChild(rewardPanel);

                // Coin rays
                const coinRays = createLightRays(gfx, {
                    rayCount: 18,
                    innerRadius: 10,
                    outerRadius: 90,
                    innerWidth: 0.05,
                    outerWidth: 0.10
                });
                coinRays.x = centerX;
                coinRays.y = rewardPanelY + 55;
                stage.addChild(coinRays);

                game.on('update', () => {
                    coinRays.rotation -= 0.003;
                });

                // Reward coin
                const rewardCoinContainer = gfx.createContainer();
                rewardCoinContainer.x = centerX;
                rewardCoinContainer.y = rewardPanelY + 50;
                stage.addChild(rewardCoinContainer);

                const rewardCoin = gfx.createText('\u{1FA99}', { fontSize: 56 });
                rewardCoin.anchor.set(0.5);
                rewardCoinContainer.addChild(rewardCoin);

                setTimeout(() => {
                    celebration.addShimmer(rewardCoinContainer, 'gold');
                }, 500);

                // Reward amount
                const rewardAmount = gfx.createText('40', {
                    fontSize: 40,
                    fontWeight: 'bold',
                    fill: colors.textWhite,
                    stroke: { color: colors.textOutline, width: 5 }
                });
                rewardAmount.anchor.set(0.5);
                rewardAmount.x = centerX;
                rewardAmount.y = rewardPanelY + 112;
                stage.addChild(rewardAmount);

                // Buttons
                const btnY = rewardPanelY + rewardPanelHeight + 30;
                const btnWidth = 120;
                const btnHeight = 50;
                const btnGap = 20;

                const continueBtn = create3DButton(gfx, centerX - btnWidth - btnGap/2, btnY, btnWidth, btnHeight, {
                    mainColor: colors.greenBtn,
                    shadowColor: colors.greenBtnShadow,
                    highlightColor: colors.greenBtnHighlight
                });
                stage.addChild(continueBtn);

                const continueText = gfx.createText('Continue', {
                    fontSize: 18,
                    fontWeight: 'bold',
                    fill: colors.textWhite,
                    dropShadow: true,
                    dropShadowColor: 0x000000,
                    dropShadowDistance: 1,
                    dropShadowBlur: 1
                });
                continueText.anchor.set(0.5);
                continueText.x = centerX - btnWidth/2 - btnGap/2;
                continueText.y = btnY + btnHeight/2;
                stage.addChild(continueText);

                const adBtn = create3DButton(gfx, centerX + btnGap/2, btnY, btnWidth, btnHeight, {
                    mainColor: colors.orangeBtn,
                    shadowColor: colors.orangeBtnShadow,
                    highlightColor: colors.orangeBtnHighlight
                });
                stage.addChild(adBtn);

                const videoIcon = gfx.createText('\u{1F3AC}', { fontSize: 18 });
                videoIcon.anchor.set(0.5);
                videoIcon.x = centerX + btnGap/2 + 20;
                videoIcon.y = btnY + btnHeight/2;
                stage.addChild(videoIcon);

                const adAmountText = gfx.createText('80', {
                    fontSize: 18,
                    fontWeight: 'bold',
                    fill: colors.textDark
                });
                adAmountText.anchor.set(0.5);
                adAmountText.x = centerX + btnGap/2 + 55;
                adAmountText.y = btnY + btnHeight/2 - 3;
                stage.addChild(adAmountText);

                const smallCoin = gfx.createText('\u{1FA99}', { fontSize: 14 });
                smallCoin.anchor.set(0.5);
                smallCoin.x = centerX + btnGap/2 + 82;
                smallCoin.y = btnY + btnHeight/2 - 3;
                stage.addChild(smallCoin);

                const x2Badge = gfx.createText('x2', {
                    fontSize: 11,
                    fontWeight: 'bold',
                    fill: 0xe85050
                });
                x2Badge.anchor.set(0.5);
                x2Badge.x = centerX + btnGap/2 + 100;
                x2Badge.y = btnY + btnHeight/2 + 8;
                stage.addChild(x2Badge);

                // Victory confetti
                setTimeout(() => {
                    celebration.victory();
                }, 300);

                // Button hover effects
                continueBtn.mainBtn.on('pointerover', () => continueBtn.mainBtn.tint = 0xccffcc);
                continueBtn.mainBtn.on('pointerout', () => continueBtn.mainBtn.tint = 0xffffff);
                adBtn.mainBtn.on('pointerover', () => adBtn.mainBtn.tint = 0xffffee);
                adBtn.mainBtn.on('pointerout', () => adBtn.mainBtn.tint = 0xffffff);
            }

            window.createVictoryScreen = createVictoryScreen;

            game.on('update', (deltaTime) => {
                celebration.update(deltaTime);
            });

            document.body.classList.toggle('light-theme', currentTheme === 'light');
            createVictoryScreen();
            game.start();
        })();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameBottomSheet Demo - GameByte Framework</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { overflow: hidden; background: #1a1a2e; transition: background 0.3s ease; }
        body.light-theme { background: #e8eef5; }
        canvas { display: block; margin: 0 auto; }
    </style>
</head>
<body>
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@8/dist/pixi.min.js"></script>
    <script src="/gamebyte.umd.js"></script>

    <script>
        // =====================================================
        // GameBottomSheet Framework Component Demo
        // =====================================================
        // This demo showcases the GameBottomSheet component:
        // - Import and use GameBottomSheet from framework
        // - Configure height ('half', 'full', 'auto')
        // - Show/hide animations
        // - Drag-to-dismiss functionality
        // - Custom content with framework graphics
        // - Theme support (dark/light)
        // =====================================================

        const { createGame, GameBottomSheet, graphics, loadFrameworkFont, CelebrationManager } = GameByteFramework;

        const CONFIG = { width: 360, height: 640 };

        // ===== THEME DETECTION =====
        function detectTheme() {
            try {
                if (window.parent && window.parent.document) {
                    const parentTheme = window.parent.document.documentElement.getAttribute('data-theme');
                    if (parentTheme) return parentTheme;
                }
            } catch (e) { /* Cross-origin */ }

            const urlParams = new URLSearchParams(window.location.search);
            const themeParam = urlParams.get('theme');
            if (themeParam) return themeParam;

            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
                return 'light';
            }
            return 'dark';
        }

        let currentTheme = detectTheme();

        function setupThemeListener() {
            try {
                if (window.parent && window.parent.document) {
                    const observer = new MutationObserver((mutations) => {
                        mutations.forEach((mutation) => {
                            if (mutation.attributeName === 'data-theme') {
                                const newTheme = window.parent.document.documentElement.getAttribute('data-theme');
                                if (newTheme && newTheme !== currentTheme) {
                                    currentTheme = newTheme;
                                    applyTheme();
                                }
                            }
                        });
                    });
                    observer.observe(window.parent.document.documentElement, { attributes: true });
                }
            } catch (e) {
                window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', (e) => {
                    currentTheme = e.matches ? 'light' : 'dark';
                    applyTheme();
                });
            }
        }

        // ===== THEME COLOR PALETTES =====
        const THEME_COLORS = {
            dark: {
                bgColor: 0x1a1a2e,
                titleDecorColor: 0x6366f1,
                titleTextColor: 0xffffff,
                btnGlowColor: 0x6366f1,
                btnBorderColor: 0x4F51C5,
                btnFillColor: 0x6366f1,
                btnTextColor: 0xffffff,
                sheetBackground: 0x2d2d44,
                sheetBorder: 0x4d4d6c,
                itemBorderColor: 0x4d4d6c,
                itemBgColor: 0x3d3d5c,
                itemNameColor: 0xffffff,
                itemDescColor: 0x888888,
                rareBorderColor: 0x8B5CF6,
                rareNameColor: 0xC4B5FD,
                rareBadgeColor: 0x8B5CF6,
                instrColor: 0x888888
            },
            light: {
                bgColor: 0xe8eef5,
                titleDecorColor: 0x6366f1,
                titleTextColor: 0x2d2d44,
                btnGlowColor: 0x818cf8,
                btnBorderColor: 0x6366f1,
                btnFillColor: 0x818cf8,
                btnTextColor: 0xffffff,
                sheetBackground: 0xf5f7fa,
                sheetBorder: 0xc5cae8,
                itemBorderColor: 0xd0d5e0,
                itemBgColor: 0xffffff,
                itemNameColor: 0x2d2d44,
                itemDescColor: 0x6b7280,
                rareBorderColor: 0x8B5CF6,
                rareNameColor: 0x7C3AED,
                rareBadgeColor: 0x8B5CF6,
                instrColor: 0x6b7280
            }
        };

        function getColors() {
            return THEME_COLORS[currentTheme] || THEME_COLORS.dark;
        }

        const canvas = document.createElement('canvas');
        canvas.width = CONFIG.width;
        canvas.height = CONFIG.height;
        document.body.appendChild(canvas);

        const game = createGame();
        let celebration = null;
        let renderer, stage;
        let currentSheet = null;

        let isRecreating = false;
        async function applyTheme() {
            if (isRecreating) return;
            isRecreating = true;

            document.body.classList.toggle('light-theme', currentTheme === 'light');
            if (stage && window.createScreen) {
                await loadFrameworkFont();
                window.createScreen();
            }
            setTimeout(() => { isRecreating = false; }, 100);
        }

        /**
         * Create item list content for the bottom sheet
         */
        function createItemListContent(heightOption) {
            const colors = getColors();
            const gfx = graphics();
            const container = gfx.createContainer();

            const items = [
                { icon: 'âš”ï¸', name: 'Sword', desc: 'Attack +10', rarity: 'common' },
                { icon: 'ðŸ›¡ï¸', name: 'Shield', desc: 'Defense +15', rarity: 'common' },
                { icon: 'ðŸ§ª', name: 'Potion', desc: 'Health +50', rarity: 'common' },
                { icon: 'ðŸ”®', name: 'Magic Orb', desc: 'Magic +20', rarity: 'rare' },
                { icon: 'ðŸ‘Ÿ', name: 'Boots', desc: 'Speed +5', rarity: 'common' }
            ];

            // Show fewer items for 'half' sheet
            const visibleItems = heightOption === 'half' ? items.slice(0, 3) : items;

            visibleItems.forEach((item, i) => {
                const itemContainer = gfx.createContainer();
                itemContainer.x = 0;
                itemContainer.y = i * 60;
                container.addChild(itemContainer);

                // Item border
                const itemBorder = gfx.createGraphics();
                itemBorder.roundRect(0, 0, CONFIG.width - 40, 52, 11);
                itemBorder.fill(item.rarity === 'rare' ? colors.rareBorderColor : colors.itemBorderColor);
                itemContainer.addChild(itemBorder);

                // Item background
                const itemBg = gfx.createGraphics();
                itemBg.roundRect(2, 2, CONFIG.width - 44, 48, 10);
                itemBg.fill(colors.itemBgColor);
                itemBg.eventMode = 'static';
                itemBg.cursor = 'pointer';
                itemContainer.addChild(itemBg);

                // Icon with shimmer for rare items
                const iconContainer = gfx.createContainer();
                iconContainer.x = 25;
                iconContainer.y = 26;
                itemContainer.addChild(iconContainer);

                const icon = gfx.createText(item.icon, { fontSize: 24 });
                icon.anchor.set(0.5);
                iconContainer.addChild(icon);

                if (item.rarity === 'rare' && celebration) {
                    celebration.addShimmer(iconContainer, 'gem');
                }

                // Item name
                const name = gfx.createText(item.name, {
                    fontSize: 16,
                    fontWeight: 'bold',
                    fill: item.rarity === 'rare' ? colors.rareNameColor : colors.itemNameColor
                });
                name.x = 50;
                name.y = 10;
                itemContainer.addChild(name);

                // Item description
                const desc = gfx.createText(item.desc, {
                    fontSize: 12,
                    fill: colors.itemDescColor
                });
                desc.x = 50;
                desc.y = 30;
                itemContainer.addChild(desc);

                // Rare badge
                if (item.rarity === 'rare') {
                    const badge = gfx.createGraphics();
                    badge.roundRect(CONFIG.width - 95, 15, 40, 20, 5);
                    badge.fill(colors.rareBadgeColor);
                    itemContainer.addChild(badge);

                    const badgeText = gfx.createText('Rare', {
                        fontSize: 10,
                        fontWeight: 'bold',
                        fill: 0xffffff
                    });
                    badgeText.anchor.set(0.5);
                    badgeText.x = CONFIG.width - 75;
                    badgeText.y = 25;
                    itemContainer.addChild(badgeText);
                }

                // Click handler
                itemBg.on('pointerdown', () => {
                    // Calculate world Y position for celebration
                    const sheetContainer = currentSheet.getContainer();
                    const panelY = sheetContainer.children[1].y; // panelContainer
                    const worldY = panelY + 80 + itemContainer.y + 26; // 80 = content offset

                    if (celebration) {
                        celebration.rewardReceived(CONFIG.width / 2, worldY);
                    }
                    console.log('Selected:', item.name);
                    setTimeout(() => currentSheet.close(), 200);
                });
            });

            return container;
        }

        /**
         * Show bottom sheet with specified height configuration
         */
        async function showBottomSheet(heightOption, title) {
            const colors = getColors();

            // Create new sheet with framework component
            currentSheet = new GameBottomSheet({
                height: heightOption,
                title: title,
                showHandle: true,
                dragToClose: true,
                theme: {
                    background: colors.sheetBackground,
                    border: colors.sheetBorder,
                    overlayAlpha: 0.6
                }
            });

            // Initialize with screen dimensions
            currentSheet.initialize(CONFIG.width, CONFIG.height);

            // Add custom content (item list)
            const itemList = createItemListContent(heightOption);
            currentSheet.addContent(itemList);

            // Add to stage
            stage.addChild(currentSheet.getContainer());

            // Show with animation
            await currentSheet.show();

            // Listen for close event
            currentSheet.on('close', () => {
                stage.removeChild(currentSheet.getContainer());
                currentSheet.destroy();
                currentSheet = null;
            });
        }

        /**
         * Create main screen with buttons
         */
        function createScreen() {
            const colors = getColors();
            const gfx = graphics();

            while (stage.children.length > 0) {
                stage.removeChildAt(0);
            }
            if (celebration) {
                celebration.clear();
            }

            // Background
            const bg = gfx.createGraphics();
            bg.rect(0, 0, CONFIG.width, CONFIG.height);
            bg.fill(colors.bgColor);
            stage.addChild(bg);

            // Title decorations
            const titleDecorLeft = gfx.createGraphics();
            titleDecorLeft.roundRect(30, 60, 50, 3, 2);
            titleDecorLeft.fill(colors.titleDecorColor);
            stage.addChild(titleDecorLeft);

            const titleDecorRight = gfx.createGraphics();
            titleDecorRight.roundRect(CONFIG.width - 80, 60, 50, 3, 2);
            titleDecorRight.fill(colors.titleDecorColor);
            stage.addChild(titleDecorRight);

            const pageTitle = gfx.createText('Select an Item', {
                fontSize: 24,
                fontWeight: 'bold',
                fill: colors.titleTextColor,
                dropShadow: currentTheme === 'dark',
                dropShadowDistance: 2
            });
            pageTitle.anchor.set(0.5);
            pageTitle.x = CONFIG.width / 2;
            pageTitle.y = 60;
            stage.addChild(pageTitle);

            // Buttons to show different sheet configurations
            const sizes = [
                { label: 'Half Sheet', height: 'half', icon: 'ðŸ“‹', title: 'Select Item' },
                { label: 'Full Sheet', height: 'full', icon: 'ðŸ“„', title: 'All Items' },
                { label: 'Auto Sheet', height: 'auto', icon: 'auto', title: 'Quick Select' }
            ];

            sizes.forEach((size, i) => {
                const btnGlow = gfx.createGraphics();
                btnGlow.roundRect(35, 115 + i * 70, CONFIG.width - 70, 60, 14);
                btnGlow.fill({ color: colors.btnGlowColor, alpha: 0.2 });
                stage.addChild(btnGlow);

                const btnBorder = gfx.createGraphics();
                btnBorder.roundRect(38, 118 + i * 70, CONFIG.width - 76, 57, 13);
                btnBorder.fill(colors.btnBorderColor);
                stage.addChild(btnBorder);

                const btn = gfx.createGraphics();
                btn.roundRect(40, 120 + i * 70, CONFIG.width - 80, 55, 12);
                btn.fill(colors.btnFillColor);
                btn.eventMode = 'static';
                btn.cursor = 'pointer';
                stage.addChild(btn);

                const icon = gfx.createText(size.icon, { fontSize: 20 });
                icon.x = 60;
                icon.y = 135 + i * 70;
                stage.addChild(icon);

                const text = gfx.createText(size.label, {
                    fontSize: 18,
                    fontWeight: 'bold',
                    fill: colors.btnTextColor
                });
                text.anchor.set(0.5);
                text.x = CONFIG.width / 2 + 10;
                text.y = 147 + i * 70;
                stage.addChild(text);

                btn.on('pointerdown', () => showBottomSheet(size.height, size.title));
            });

            // Instructions
            const instr = gfx.createText('Drag handle down to close', {
                fontSize: 12,
                fill: colors.instrColor
            });
            instr.anchor.set(0.5);
            instr.x = CONFIG.width / 2;
            instr.y = CONFIG.height - 30;
            stage.addChild(instr);
        }

        (async () => {
            await loadFrameworkFont();
            await game.initialize(canvas, '2d');
            renderer = game.make('renderer');
            stage = renderer.getStage();

            celebration = new CelebrationManager(stage, CONFIG.width, CONFIG.height);
            setupThemeListener();

            window.createScreen = createScreen;

            game.on('update', (deltaTime) => {
                if (celebration) {
                    celebration.update(deltaTime);
                }
            });

            document.body.classList.toggle('light-theme', currentTheme === 'light');
            createScreen();
            game.start();
        })();
    </script>
</body>
</html>
